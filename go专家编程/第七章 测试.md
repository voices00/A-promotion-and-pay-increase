## 第七章 测试

 	目前Go测试系统支持单元测试、性能测试和示例测试。 

### 7.1 快速开始

> ​	单元测试是指对软件中的最小可测试单元进行检查和验证，比如对一个函数的测试。
>
> ​	 性能测试，也称基准测试，可以测试一段程序的性能，可以得到时间消耗、内存使用情况的报告。 
>
> ​	 示例测试，广泛应用于Go源码和各种开源框架中，用于展示某个包或某个方法的用法。 

#### 单元测试

> 编写一个单元测试并执行需要遵循以下的规则：
>
> - 测试文件名必须以`test.go`结尾；
> - 测试函数名必须以`TestXxx`开始；
> - 命令行下使用`go test`即可启动测试。

#### 基准测试

> 编写并执行性能测试需要遵循以下规则：
>
> - 文件名必须以`test.go`结尾；
> - 函数名必须以`BenchmarkXxx`开始；
> - 使用命令`go test -bench=.`即可开始性能测试；

#### 示例测试

> 1. 示例测试函数名需要以`Example`开头；
> 2. 检测单行输出格式为`// Output: <期望字符串>`；
> 3. 检测多行输出格式为`// Output: \ <期望字符串> \ <期望字符串>`，每个期望字符串占一行；
> 4. 检测无序输出格式为`// Unordered output: \ <期望字符串> \ <期望字符串>`，每个期望字符串占一行；
> 5. 测试字符串时会自动忽略字符串前后的空白字符；
> 6. 如果测试函数中没有`Output`标识，则该测试函数不会被执行；
> 7. 执行测试可以使用`go test`，此时该目录下的其他测试文件也会一并执行；
> 8. 执行测试可以使用`go test <xxx_test.go> `，此时仅执行特定文件中的测试函数。

### 7.2 进阶测试

#### 子测试

​	 子测试提供一种在一个测试函数中执行多个测试的能力，比如原来有TestA、TestB和TestC三个测试函数，每个测试函数执行开始都需要做些相同的初始化工作，那么可以利用子测试将这三个测试合并到一个测试中，这样初始化工作只需要做一次。 

> - 子测试适用于单元测试和性能测试；
> - 子测试可以控制并发；
> - 子测试提供一种类似table-driven风格的测试；
> - 子测试可以共享setup和tear-down。

#### Main测试

​	 所谓Main测试，即声明一个`func TestMain(m *testing.M)`，它是名字比较特殊的测试，参数类型为`testing.M`指针。如果声明了这样一个函数，当前测试程序将不是直接执行各项测试，而是将测试交给TestMain调度。 

​	 TestMain执行时，命令行参数还未解析，如果测试程序需要依赖参数，可以使用`flag.Parse()`解析参数，m.Run()方法内部还会再次解析参数，此处解析不会影响原测试过程。 

### 7.3 实现原理

#### `testing.common`公共类

​	单元测试函数需要传递一个`testing.T`类型的参数，而性能测试函数需要传递一个`testing.B`类型的参数，该参数可用于控制测试的流程，比如标记测试失败等。`testing.T`和`testing.B`属于`testing`包中的两个数据类型，该类型提供一系列的方法用于控制函数执行流程，考虑到二者有一定的相似性，所以Go实现时抽象出一个`testing.common`作为一个基础类型，而`testing.T`和`testing.B`则属于`testing.common`的扩展。

#### `testing.TB`接口

​	TB接口是`testing.T`(单元测试)和`testing.B`(性能测试)共用的接口。

​	TB接口通过在接口中定义一个名为private(）的私有方法，保证了即使用户实现了类似的接口，也不会跟`testing.TB`接口冲突。其目的是限定`testing.TB`接口的全局唯一性，即便用户的某个类型实现了除private()方法以外的其他方法，也不能说明实现了`testing.TB`接口，因为无法实现private()方法，private()方法属于testing包内部可见，外部不可见。 

​	对外接口需要`testing.T`和`testing.B`实现，但由于`testing.T`和`testing.B`都继承了`testing.common`，而`testing.common`已经实现了这些接口，所以`testing.T`和`testing.B`天然实现了TB接口。其中私有接口`private()`用于控制该接口的唯一性，即便用户代码中某个类型实现了这些方法，由于无法实现这个私有接口，也不能被认为是实现了TB接口，所以不会跟用户代码产生冲突。

#### 单元测试实现原理

```go
type T struct {
    common
    isParallel bool
    context    *testContext // For running tests and subtests.
}
```

- common： 即前面绍的`testing.common`
- `isParallel`： 表示当前测试是否需要并发，如果测试中执行了`t.Parallel()`，则此值为true
- context： 控制测试的并发调度

